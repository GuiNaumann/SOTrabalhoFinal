<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Máquinas – Trabalho Sistemas Operacionais</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Fonte padrão da página */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f8fa;
            color: #333;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header com navegação */
        .header {
            background-color: #2c3e50;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            max-width: 1300px;
            margin: 0 auto;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-logo i {
            margin-right: 10px;
            color: #3498db;
        }

        .nav-user {
            display: flex;
            align-items: center;
        }

        .user-info {
            margin-right: 20px;
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        /* Container centralizado */
        .container {
            max-width: 1300px;
            margin: 2rem auto;
            padding: 0 2rem;
            flex-grow: 1;
        }

        /* Cards para diferentes seções */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            background-color: #fafafa;
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 10px;
            color: #3498db;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Breadcrumbs para navegação */
        .breadcrumb {
            display: flex;
            list-style: none;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            color: #7f8c8d;
        }

        .breadcrumb-item a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '/';
            margin: 0 8px;
            color: #ccc;
        }

        .breadcrumb-item.active {
            color: #34495e;
            font-weight: 600;
        }

        /* Campo de pesquisa */
        .search-container {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .search-container input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52,152,219,0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        /* Tabelas estilizadas */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1rem;
        }

        th, td {
            padding: 1rem 1.2rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        thead th {
            color: #34495e;
            font-weight: 600;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fb;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Status indicators */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .status-online {
            background-color: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }

        .status-online::before {
            content: "";
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-right: 6px;
        }

        /* Botões de ação */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn i {
            margin-right: 6px;
            font-size: 0.85rem;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: #3498db;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #2ecc71;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* Mensagens de estado (quando não há dados) */
        .empty-message {
            padding: 2rem;
            background-color: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 6px;
            color: #7f8c8d;
            text-align: center;
            font-size: 1rem;
        }

        .empty-message i {
            display: block;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }

        /* Indicador de carregamento */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1.5rem 0;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: #ecf0f1;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #3498db;
        }

        /* Stats cards in process section */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .stat-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-card:nth-child(2) .stat-icon {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .stat-card:nth-child(3) .stat-icon {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .stat-card:nth-child(4) .stat-icon {
            background-color: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            list-style: none;
            margin-top: 1.5rem;
            gap: 5px;
        }

        .pagination button {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
            height: 35px;
            padding: 0 10px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #3498db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .pagination button:hover {
            background-color: #f8f9fa;
            border-color: #bdc3c7;
        }

        .pagination button.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .pagination button.disabled {
            color: #bdc3c7;
            pointer-events: none;
        }

        .pagination .ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            color: #7f8c8d;
        }

        /* Gráfico de uso de CPU/Memória */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 2rem;
        }

        /* Estilo para tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            position: relative;
            color: #7f8c8d;
            font-weight: 500;
            transition: color 0.2s;
        }

        .tab.active {
            color: #3498db;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #3498db;
        }

        .tab:hover:not(.active) {
            color: #34495e;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav {
                flex-direction: column;
                height: auto;
                padding: 1rem 0;
            }

            .nav-logo {
                margin-bottom: 1rem;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-container input {
                padding: 10px 15px 10px 40px;
            }

            th, td {
                padding: 0.8rem;
            }

            .footer-content {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Modal para detalhes de processo */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .process-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.3rem;
        }

        .detail-value {
            font-size: 1.1rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
<!-- Header com navegação -->
<div class="header">
    <div class="nav">
        <div class="nav-logo">
            <i class="fas fa-server"></i>
            Monitor de Máquinas
        </div>
        <div class="nav-user">
            <div class="user-info">
                <div class="user-name" id="username">Admin</div>
                <div class="user-role">Administrador</div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </div>
</div>

<div class="container">
    <!-- Breadcrumb de navegação -->
    <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Início</a></li>
        <li class="breadcrumb-item active">Monitoramento</li>
    </ul>

    <!-- Seção de Agentes -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-desktop"></i> Agentes Online
            </h2>
        </div>
        <div class="card-body">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input
                        type="text"
                        id="agent-search"
                        placeholder="Pesquisar agente por ID ou Endereço RPC"
                />
            </div>

            <div id="agents-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Carregando agentes...</p>
            </div>

            <div id="agents-empty" class="empty-message" style="display: none;">
                <i class="fas fa-robot"></i>
                <p>Nenhum agente registrado no momento.</p>
            </div>

            <table id="agents-table" style="display: none;">
                <thead>
                <tr>
                    <th>Status</th>
                    <th>Agent ID</th>
                    <th>Endereço RPC</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="agents-body">
                </tbody>
            </table>

            <ul id="agents-pagination" class="pagination" style="display: none;"></ul>
        </div>
    </div>

    <!-- Seção de Processos -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-microchip"></i> Processos do Agente: <span id="current-agent">nenhum</span>
            </h2>
        </div>
        <div class="card-body">
            <!-- Cards de estatísticas -->
            <div class="stats-container" id="process-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-value" id="total-processes">0</div>
                    <div class="stat-label">Total de Processos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="stat-value" id="memory-usage">0%</div>
                    <div class="stat-label">Uso de Memória</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stat-value" id="cpu-usage">0%</div>
                    <div class="stat-label">Uso de CPU</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-stopwatch"></i>
                    </div>
                    <div class="stat-value" id="uptime">0h</div>
                    <div class="stat-label">Tempo Ativo</div>
                </div>
            </div>

            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input
                        type="text"
                        id="process-search"
                        placeholder="Pesquisar processo por PID ou nome"
                />
            </div>

            <div id="processes-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Carregando processos...</p>
            </div>

            <div id="processes-empty" class="empty-message" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <p>Nenhum processo encontrado para este agente.</p>
            </div>

            <table id="process-table" style="display: none;">
                <thead>
                <tr>
                    <th>PID</th>
                    <th>Nome</th>
                    <th>CPU (%)</th>
                    <th>Memória (%)</th>
                    <th>Ação</th>
                </tr>
                </thead>
                <tbody id="process-body">
                </tbody>
            </table>

            <div class="card-header" style="margin-top: 2rem;">
                <h2 class="card-title">
                    <i class="fas fa-power-off"></i> Processos Finalizados
                </h2>
            </div>

            <div id="killed-empty" class="empty-message" style="display: none;">
                <i class="fas fa-power-off"></i>
                <p>Nenhum processo finalizado para mostrar.</p>
            </div>

            <table id="killed-table">
                <thead>
                <tr>
                    <th>PID</th>
                    <th>Ação</th>
                </tr>
                </thead>
                <tbody id="killed-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Processo -->
<div class="modal" id="process-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-process-title">Detalhes do Processo</h3>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="process-details" id="process-details-container">
                <!-- Conteúdo dinâmico gerado pelo JavaScript -->
            </div>

            <div class="chart-container">
                <canvas id="resource-chart"></canvas>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="modal-kill-btn">
                <i class="fas fa-stop-circle"></i> Finalizar Processo
            </button>
            <button class="btn" id="modal-close-btn">Fechar</button>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="footer">
    <div class="footer-content">
        <div class="footer-info">
            &copy; 2025 Trabalho Sistemas Operacionais - Guilherme A. Naumann, Guilherme Goedert Hoegen e Matheus Tallmann
        </div>
        <div class="footer-links">
            <a href="#">Sobre</a>
            <a href="#">Documentação</a>
            <a href="#">Ajuda</a>
        </div>
    </div>
</div>

<!-- Adicione o script do Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Verificação de autenticação
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
            return;
        }

        // Exibe o nome do usuário
        const username = localStorage.getItem('username');
        if (username) {
            document.getElementById('username').textContent = username;
        }

        // Inicializa a lista de agentes
        loadAgents();
        setupEventListeners();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
    });

    // Variáveis globais
    let agentsList = [];
    let filteredAgents = [];
    let currentPageAgents = 1;
    const itemsPerPageAgents = 5;
    const maxPageButtons = 5;
    let currentAgent = '';

    let processesList = [];
    let filteredProcesses = [];

    let wsProcess = null;
    let resourceChart = null;

    // Elementos DOM
    const agentSearchInput = document.getElementById('agent-search');
    const agentsBody = document.getElementById('agents-body');
    const agentsTable = document.getElementById('agents-table');
    const agentsLoading = document.getElementById('agents-loading');
    const agentsEmpty = document.getElementById('agents-empty');
    const agentsPagination = document.getElementById('agents-pagination');

    const processSearchInput = document.getElementById('process-search');
    const processBody = document.getElementById('process-body');
    const processTable = document.getElementById('process-table');
    const processesLoading = document.getElementById('processes-loading');
    const processesEmpty = document.getElementById('processes-empty');
    const currentAgentSpan = document.getElementById('current-agent');

    const killedTable = document.getElementById('killed-table');
    const killedBody = document.getElementById('killed-body');
    const killedEmpty = document.getElementById('killed-empty');

    const processDetailModal = document.getElementById('process-detail-modal');

    // Configuração de event listeners
    function setupEventListeners() {
        agentSearchInput.addEventListener('input', applyFilterAgents);
        processSearchInput.addEventListener('input', applyFilterProcesses);

        // Fechar modal
        document.getElementById('modal-close').addEventListener('click', () => {
            processDetailModal.style.display = 'none';
        });

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            processDetailModal.style.display = 'none';
        });

        // Fechar modal ao clicar fora
        window.addEventListener('click', (e) => {
            if (e.target === processDetailModal) {
                processDetailModal.style.display = 'none';
            }
        });
    }

    // Carregar lista de agentes
    function loadAgents() {
        agentsTable.style.display = 'none';
        agentsEmpty.style.display = 'none';
        agentsLoading.style.display = '';
        agentsPagination.style.display = 'none';

        fetch('/agents')
            .then(res => res.json())
            .then(lista => {
                agentsLoading.style.display = 'none';
                agentsList = Array.isArray(lista) ? lista : [];
                currentPageAgents = 1;
                agentSearchInput.value = '';
                applyFilterAgents();
            })
            .catch(err => {
                agentsLoading.style.display = 'none';
                console.error('Erro ao listar agentes:', err);
                agentsEmpty.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar agentes.</p>';
                agentsEmpty.style.display = '';
            });
    }

    // Filtrar agentes
    function applyFilterAgents() {
        const termo = agentSearchInput.value.trim().toLowerCase();
        if (termo === '') {
            filteredAgents = [...agentsList];
        } else {
            filteredAgents = agentsList.filter(agent => {
                return (
                    agent.ID.toLowerCase().includes(termo) ||
                    agent.RPCAddr.toLowerCase().includes(termo)
                );
            });
        }

        const totalPages = Math.ceil(filteredAgents.length / itemsPerPageAgents) || 1;
        if (currentPageAgents > totalPages) {
            currentPageAgents = totalPages;
        }

        renderAgentsTable();
        renderAgentsPagination();
    }

    // Renderizar tabela de agentes
    function renderAgentsTable() {
        agentsBody.innerHTML = '';

        if (!filteredAgents.length) {
            agentsTable.style.display = 'none';
            agentsEmpty.innerHTML = '<i class="fas fa-search"></i><p>Nenhum agente correspondente à pesquisa.</p>';
            agentsEmpty.style.display = '';
            agentsPagination.style.display = 'none';
            return;
        }

        const startIndex = (currentPageAgents - 1) * itemsPerPageAgents;
        const endIndex = startIndex + itemsPerPageAgents;
        const pageItems = filteredAgents.slice(startIndex, endIndex);

        pageItems.forEach(agent => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td><span class="status status-online">Online</span></td>
                    <td>${agent.ID}</td>
                    <td>${agent.RPCAddr}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectAgent('${agent.ID}')">
                            <i class="fas fa-desktop"></i> Ver Processos
                        </button>
                    </td>
                `;
            agentsBody.appendChild(tr);
        });

        agentsTable.style.display = '';
        agentsEmpty.style.display = 'none';
    }

    // Renderizar paginação de agentes
    function renderAgentsPagination() {
        agentsPagination.innerHTML = '';

        const totalItems = filteredAgents.length;
        const totalPages = Math.ceil(totalItems / itemsPerPageAgents) || 1;

        if (totalPages <= 1) {
            agentsPagination.style.display = 'none';
            return;
        }

        agentsPagination.style.display = '';

        function addPageButton(page, label = null, disabled = false, active = false) {
            const btn = document.createElement('button');
            btn.textContent = label || page;
            if (active) btn.classList.add('active');
            if (disabled) btn.classList.add('disabled');

            if (!disabled && !active) {
                btn.addEventListener('click', () => {
                    currentPageAgents = page;
                    renderAgentsTable();
                    renderAgentsPagination();
                });
            }

            const li = document.createElement('li');
            li.appendChild(btn);
            agentsPagination.appendChild(li);
        }

        // Botão "«"
        addPageButton(currentPageAgents - 1, '«', currentPageAgents === 1);

        // Determinar faixa de páginas
        let start = Math.max(1, currentPageAgents - Math.floor(maxPageButtons / 2));
        let end = start + maxPageButtons - 1;

        if (end > totalPages) {
            end = totalPages;
            start = Math.max(1, end - maxPageButtons + 1);
        }

        if (start > 1) {
            addPageButton(1);
            if (start > 2) {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = '…';
                span.classList.add('ellipsis');
                li.appendChild(span);
                agentsPagination.appendChild(li);
            }
        }

        for (let p = start; p <= end; p++) {
            addPageButton(p, null, false, p === currentPageAgents);
        }

        if (end < totalPages) {
            if (end < totalPages - 1) {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = '…';
                span.classList.add('ellipsis');
                li.appendChild(span);
                agentsPagination.appendChild(li);
            }
            addPageButton(totalPages);
        }

        // Botão "»"
        addPageButton(currentPageAgents + 1, '»', currentPageAgents === totalPages);
    }

    // Selecionar um agente para ver processos
    function selectAgent(agentID) {
        // Fechar WebSocket existente se houver
        if (wsProcess) {
            wsProcess.close();
            wsProcess = null;
        }

        currentAgent = agentID;
        currentAgentSpan.textContent = agentID;

        // Resetar estatísticas
        document.getElementById('total-processes').textContent = '0';
        document.getElementById('memory-usage').textContent = '0%';
        document.getElementById('cpu-usage').textContent = '0%';
        document.getElementById('uptime').textContent = '0h';

        // Exibir loading
        processTable.style.display = 'none';
        processesEmpty.style.display = 'none';
        processesLoading.style.display = '';

        // Conectar ao WebSocket
        const loc = window.location;
        const protocol = loc.protocol === 'https:' ? 'wss' : 'ws';
        const wsURL = `${protocol}://${loc.host}/agents/${agentID}/stream`;

        wsProcess = new WebSocket(wsURL);

        wsProcess.onopen = () => {
            console.log(`Conexão WebSocket estabelecida para agente ${agentID}`);
        };

        wsProcess.onmessage = (event) => {
            processesLoading.style.display = 'none';
            try {
                const lista = JSON.parse(event.data);
                processesList = Array.isArray(lista) ? lista : [];

                // Atualizar estatísticas
                updateProcessStats();
            } catch (e) {
                console.error('Erro ao processar dados WebSocket:', e);
                processesList = [];
            }

            applyFilterProcesses();
        };

        wsProcess.onerror = (err) => {
            console.error('WebSocket erro:', err);
            processesLoading.style.display = 'none';
            processesEmpty.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Erro na conexão com o agente.</p>';
            processesEmpty.style.display = '';
        };

        wsProcess.onclose = () => {
            console.log(`Conexão WebSocket encerrada para agente ${agentID}`);
        };
    }

    // Atualizar estatísticas de processos
    function updateProcessStats() {
        if (!processesList.length) return;

        // Total de processos
        document.getElementById('total-processes').textContent = processesList.length;

        // Calcular uso total de CPU e memória
        let totalCpu = 0;
        let totalMemory = 0;

        processesList.forEach(p => {
            totalCpu += p.cpu || 0;
            totalMemory += p.memory || 0;
        });

        // Limitar totais a 100%
        totalCpu = Math.min(totalCpu, 100);
        totalMemory = Math.min(totalMemory, 100);

        document.getElementById('cpu-usage').textContent = `${totalCpu.toFixed(1)}%`;
        document.getElementById('memory-usage').textContent = `${totalMemory.toFixed(1)}%`;

        // Tempo ativo simulado (apenas para demonstração)
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
    }

    // Filtrar processos
    function applyFilterProcesses() {
        const termo = processSearchInput.value.trim().toLowerCase();

        if (termo === '') {
            filteredProcesses = [...processesList];
        } else {
            filteredProcesses = processesList.filter(p => {
                return (
                    p.pid.toString().includes(termo) ||
                    (p.name && p.name.toLowerCase().includes(termo))
                );
            });
        }

        renderProcessesTable();
    }

    // Renderizar tabela de processos
    function renderProcessesTable() {
        processBody.innerHTML = '';

        if (!filteredProcesses.length) {
            processTable.style.display = 'none';
            processesEmpty.innerHTML = '<i class="fas fa-info-circle"></i><p>Nenhum processo encontrado para este agente.</p>';
            processesEmpty.style.display = '';
            return;
        }

        filteredProcesses.forEach(p => {
            // Usar p.name para exibir, ou fallback
            const displayName = p.name && p.name.trim() !== '' ? p.name : '<unknown>';

            // Criar a linha e guardar o caminho completo em data-path
            const tr = document.createElement('tr');
            tr.id = `row-${p.pid}`;
            tr.dataset.path = p.path || '';

            // Montar o HTML da linha
            tr.innerHTML = `
                    <td>${p.pid}</td>
                    <td>${displayName}</td>
                    <td>${p.cpu.toFixed(1)}</td>
                    <td>${p.memory.toFixed(1)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="killProcess('${currentAgent}', ${p.pid})">
                            <i class="fas fa-stop-circle"></i> Finalizar
                        </button>
                        <button class="btn" onclick="showProcessDetails(${p.pid})">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>
                    </td>
                `;

            processBody.appendChild(tr);
        });

        processTable.style.display = '';
        processesEmpty.style.display = 'none';
    }

    // Mostrar detalhes do processo
    function showProcessDetails(pid) {
        const process = processesList.find(p => p.pid === pid);
        if (!process) return;

        const modalTitle = document.getElementById('modal-process-title');
        const detailsContainer = document.getElementById('process-details-container');
        const killBtn = document.getElementById('modal-kill-btn');

        modalTitle.textContent = `${process.name || 'Processo'} (PID: ${process.pid})`;

        // Estruturar detalhes do processo
        detailsContainer.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">PID</div>
                    <div class="detail-value">${process.pid}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Nome</div>
                    <div class="detail-value">${process.name || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Uso de CPU</div>
                    <div class="detail-value">${process.cpu.toFixed(1)}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Uso de Memória</div>
                    <div class="detail-value">${process.memory.toFixed(1)}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Caminho</div>
                    <div class="detail-value">${process.path || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">Em execução</div>
                </div>
            `;

        // Configurar botão de finalizar processo
        killBtn.onclick = () => {
            killProcess(currentAgent, process.pid);
            processDetailModal.style.display = 'none';
        };

        // Atualizar ou criar gráfico
        updateResourceChart(process);

        // Exibir modal
        processDetailModal.style.display = 'flex';
    }

    // Atualizar gráfico de recursos
    function updateResourceChart(process) {
        const ctx = document.getElementById('resource-chart').getContext('2d');

        // Destruir gráfico existente se houver
        if (resourceChart) {
            resourceChart.destroy();
        }

        // Criar novo gráfico
        resourceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['CPU', 'Memória'],
                datasets: [{
                    label: 'Uso de Recursos (%)',
                    data: [process.cpu, process.memory],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Porcentagem (%)'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Utilização de Recursos',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Finalizar processo - USANDO O CÓDIGO ORIGINAL QUE FUNCIONA
    function killProcess(agentID, pid) {
        if (!confirm(`Deseja finalizar o processo PID ${pid}?`)) return;

        fetch(`/agents/${agentID}/kill`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ pid })
        })
            .then(res => res.json())
            .then(reply => {
                if (!reply.success) {
                    alert('Falha ao finalizar: ' + reply.message);
                    return;
                }

                // pega a linha, configura botão "Iniciar" e move pra finalizados
                const row = document.getElementById(`row-${pid}`);
                const fullPath = row.dataset.path || '';
                const btn = row.querySelector('button');

                btn.textContent = 'Iniciar';
                btn.className = 'btn btn-success';
                btn.onclick = () => startProcess(agentID, fullPath, pid);

                document.getElementById('killed-body').appendChild(row);
            })
            .catch(err => {
                console.error('Erro ao matar processo:', err);
                alert('Erro ao matar processo: ' + err.message);
            });
    }

    // Iniciar processo - USANDO O CÓDIGO ORIGINAL QUE FUNCIONA
    function startProcess(agentID, fullPath, pid) {
        fetch(`/agents/${agentID}/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: fullPath })
        })
            .then(res => res.json())
            .then(reply => {
                if (!reply.success) {
                    throw new Error(reply.message || 'desconhecido');
                }
                // tudo certo: remove da lista de finalizados
                const row = document.getElementById(`row-${pid}`);
                if (row) row.remove();
            })
            .catch(err => {
                console.error('Falha ao iniciar processo:', err);
                alert('Falha ao iniciar: ' + err.message);
            });
    }
</script>
</body>
</html>